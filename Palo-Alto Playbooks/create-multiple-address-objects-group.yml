---
- name: Create Service Objects from a CSV Source File
  hosts: "firewall"
  connection: local

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"

    csv_filename: "csv/address.csv"

  collections:
    - paloaltonetworks.panos

tasks:
  - name: Read CSV file
    ansible.builtin.read_csv:
      path: "{{ csv_filename }}"
      key: hostname
    register: csv_data

  - name: Create address objects
    paloaltonetworks.panos.panos_address_object:
      provider: "{{ device }}"
      name: "{{ item.value.name }}"
      #address_type: "{{item.value.address_type }}"
      value: "{{ item.value.ip_address }}"
      #description: "{{ item.value.description }}"
      #tag: "{{ item.value.tag }}"

  - name: Create a list of the address objects
    ansible.builtin.set_fact:
      address_objects_list: "{{ csv_data.dict | dict2items | map(attribute='key') | list }}"

  - name: Add address objects to address group
    paloaltonetworks.panos.panos_address_group:
      provider: "{{ device }}"
      name: Web Server Group 1
      static_value: "{{ address_objects_list }}"